# 联盟营销数据采集系统 - 多用户SaaS版

## 🎯 系统概述

这是一个多用户SaaS系统，允许用户注册后配置自己的联盟平台账号，系统会**自动登录平台并采集数据**，无需用户手动输入验证码。

### 核心特性

✅ **双层认证系统**
- 用户在SaaS系统注册/登录
- 后端自动登录LH平台（带验证码自动识别）

✅ **多账号管理**
- 每个用户可配置多个平台账号
- 账号密码加密存储（AES-256）

✅ **自动数据采集**
- Token过期自动重新登录
- 验证码自动识别（ddddocr）
- 订单数据自动保存到数据库

✅ **数据持久化**
- SQLite数据库（零配置）
- 历史数据查询
- 统计分析

---

## 🚀 快速开始

### 1. 安装依赖

```bash
npm install
```

### 2. 安装Python OCR依赖（验证码识别）

```bash
pip install ddddocr pillow
```

### 3. 启动服务器

```bash
npm start
```

服务器会在 `http://localhost:3000` 启动

### 4. 访问系统

打开浏览器访问：`http://localhost:3000/index-v2.html`

---

## 📋 使用流程

### 第一步：注册账号

1. 访问系统首页
2. 点击"注册"标签
3. 填写用户名、邮箱、密码
4. 提交注册

### 第二步：添加平台账号

1. 登录成功后进入主页面
2. 点击"+ 添加平台账号"
3. 选择平台（目前支持LinkHaitao）
4. 填写平台的登录用户名和密码
5. 提交

**注意**：这里填写的是**LH平台的账号密码**，系统会加密保存

### 第三步：采集数据

1. 在账号列表中点击"选择"按钮
2. 选择日期范围
3. 点击"开始采集"
4. 系统会自动：
   - 获取验证码
   - 识别验证码（OCR）
   - 登录LH平台
   - 获取订单数据
   - 保存到数据库

**整个过程无需手动操作，等待10-30秒即可完成**

---

## 🔧 技术架构

### 后端技术栈

- **框架**: Express.js
- **数据库**: SQLite（better-sqlite3）
- **认证**: JWT + bcrypt
- **加密**: AES-256-CBC
- **HTTP客户端**: Axios
- **验证码识别**: ddddocr (Python)

### 前端技术栈

- 原生JavaScript（无框架）
- HTML5 + CSS3
- Fetch API

### 数据库表结构

1. **users** - SaaS用户表
2. **platform_accounts** - 平台账号配置表
3. **platform_tokens** - LH token缓存表
4. **orders** - 订单数据表
5. **collection_jobs** - 采集任务记录表

---

## 🔐 安全说明

### 密码加密

- **用户密码**: bcrypt加密（10轮salt）
- **平台账号密码**: AES-256-CBC加密
- **JWT Token**: 7天有效期

### 环境变量

在 `.env` 文件中配置：

```env
JWT_SECRET=your-jwt-secret-key
ENCRYPTION_KEY=your-32-character-encryption-key
PORT=3000
```

**重要**：生产环境务必修改默认密钥！

---

## 🐛 常见问题

### Q1: 验证码识别失败怎么办？

**A**: ddddocr识别率约70-80%，失败时系统会自动重试（最多5次）。如果连续失败：

1. 检查Python环境是否正确安装
2. 检查 `ocr_solver.py` 文件是否存在
3. 查看服务器Console日志排查错误

### Q2: Token过期怎么办？

**A**: 系统会自动检测token过期并重新登录，无需手动操作。

### Q3: 如何查看历史数据？

**A**: 目前需要通过API查询，前端历史数据页面待开发。可以使用：

```bash
# 查询订单
curl -H "Authorization: Bearer YOUR_TOKEN" \
  "http://localhost:3000/api/orders?startDate=2025-01-01&endDate=2025-01-31"
```

### Q4: 如何切换回单用户版本？

**A**: 运行旧版本服务器：

```bash
npm run start:v1
```

然后访问 `http://localhost:3000/index.html`

---

## 📁 文件说明

### 核心文件

- `server-v2.js` - 多用户版服务器
- `db.js` - 数据库配置和初始化
- `utils.js` - 工具函数（加密、JWT等）
- `ocr_solver.py` - Python验证码识别脚本

### 前端文件

- `public/index-v2.html` - 多用户版前端页面
- `public/app-v2.js` - 前端逻辑
- `public/style-v2.css` - 样式

### 旧版文件（保留）

- `server.js` - 单用户版服务器
- `public/index.html` - 单用户版前端
- `public/app.js` - 单用户版逻辑

---

## 🚧 待开发功能

- [ ] 历史数据查询页面
- [ ] 商家汇总报表
- [ ] 数据导出（Excel/CSV）
- [ ] 定时自动采集任务
- [ ] 邮件通知
- [ ] 数据可视化图表
- [ ] 升级到PostgreSQL
- [ ] 部署到云服务器

---

## 📞 获取帮助

如有问题，请检查：

1. **服务器Console日志** - 查看详细错误信息
2. **浏览器Console** - 查看前端错误
3. **数据库文件** - `data.db` 是否生成

---

## ⚠️ 重要提醒

1. **验证码识别**：使用ddddocr方案，识别率约70-80%，可能需要多次重试
2. **账号安全**：平台账号密码加密存储，但务必保管好 `.env` 文件
3. **开发环境**：当前为开发版本，生产部署需要额外配置（HTTPS、数据库优化等）

---

## 📝 版本历史

### v2.0.0 (多用户SaaS版)
- ✅ 用户注册/登录系统
- ✅ 平台账号配置管理
- ✅ 自动登录LH平台
- ✅ ddddocr验证码识别
- ✅ 订单数据持久化
- ✅ SQLite数据库

### v1.0.0 (单用户版)
- ✅ 手动登录LH平台
- ✅ 订单数据采集
- ✅ 商家汇总统计
